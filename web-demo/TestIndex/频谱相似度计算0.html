
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>频谱相似度分析</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fft.js@4.0.4/dist/fft.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
        }
        .control-panel {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 30px;
        }
        button {
            padding: 8px 16px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #2980b9;
        }
        input, select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .results {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        .match-item {
            background: #f8f9fa;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            border-left: 4px solid #3498db;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>频谱相似度分析工具</h1>
        
        <div class="control-panel">
            <div>
                <label for="targetStart">目标起始频率(MHz):</label>
                <input type="number" id="targetStart" value="100" min="10" max="920">
            </div>
            <div>
                <label for="targetWidth">带宽(MHz):</label>
                <input type="number" id="targetWidth" value="80" min="10" max="100">
            </div>
            <button id="analyzeBtn">分析相似频谱</button>
            <div>
                <label for="similarityThreshold">相似度阈值:</label>
                <input type="number" id="similarityThreshold" value="0.85" min="0.5" max="1" step="0.05">
            </div>
        </div>

        <div class="chart-container">
            <canvas id="spectrumChart"></canvas>
        </div>

        <div class="results" id="resultsContainer">
            <h3>匹配结果</h3>
            <div id="matchesList"></div>
        </div>
    </div>

    <script>
        // 模拟频谱数据 (实际应用中应从API获取)
        const sampleSpectrumData = generateSampleSpectrum(10, 1000, 1024);
        
        // 初始化图表
        const ctx = document.getElementById('spectrumChart').getContext('2d');
        const spectrumChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: sampleSpectrumData.frequencies.map(f => f.toFixed(1)),
                datasets: [{
                    label: '频谱数据 (dBm)',
                    data: sampleSpectrumData.amplitudes,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: '频率 (MHz)'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: '幅度 (dBm)'
                        }
                    }
                }
            }
        });

        // 生成模拟频谱数据
        function generateSampleSpectrum(startMHz, endMHz, points) {
            const frequencies = [];
            const amplitudes = [];
            const step = (endMHz - startMHz) / points;
            
            for (let i = 0; i < points; i++) {
                const freq = startMHz + i * step;
                frequencies.push(freq);
                
                // 模拟不同频段的信号特征
                let amplitude;
                if (freq > 200 && freq < 280) {
                    amplitude = -50 + Math.random() * 10; // 模拟强信号区
                } else if (freq > 500 && freq < 580) {
                    amplitude = -60 + Math.random() * 15; // 另一个信号区
                } else {
                    amplitude = -90 + Math.random() * 20; // 背景噪声
                }
                
                amplitudes.push(amplitude);
            }
            
            return { frequencies, amplitudes };
        }

        // 计算余弦相似度
        function cosineSimilarity(vecA, vecB) {
            let dotProduct = 0;
            let normA = 0;
            let normB = 0;
            
            for (let i = 0; i < vecA.length; i++) {
                dotProduct += vecA[i] * vecB[i];
                normA += vecA[i] * vecA[i];
                normB += vecB[i] * vecB[i];
            }
            
            normA = Math.sqrt(normA);
            normB = Math.sqrt(normB);
            
            return dotProduct / (normA * normB);
        }

        // 提取指定频段数据
        function extractBand(data, startMHz, widthMHz) {
            const startIdx = data.frequencies.findIndex(f => f >= startMHz);
            const endIdx = data.frequencies.findIndex(f => f >= startMHz + widthMHz);
            
            if (startIdx === -1 || endIdx === -1) {
                console.error('无效的频率范围');
                return null;
            }
            
            return {
                frequencies: data.frequencies.slice(startIdx, endIdx),
                amplitudes: data.amplitudes.slice(startIdx, endIdx)
            };
        }

        // 归一化频谱数据
        function normalizeSpectrum(amplitudes) {
            const min = Math.min(...amplitudes);
            const max = Math.max(...amplitudes);
            return amplitudes.map(a => (a - min) / (max - min));
        }

        // 主分析函数
        document.getElementById('analyzeBtn').addEventListener('click', function() {
            const targetStart = parseFloat(document.getElementById('targetStart').value);
            const targetWidth = parseFloat(document.getElementById('targetWidth').value);
            const threshold = parseFloat(document.getElementById('similarityThreshold').value);
            
            // 提取目标频段
            const targetBand = extractBand(sampleSpectrumData, targetStart, targetWidth);
            if (!targetBand) return;
            
            const normalizedTarget = normalizeSpectrum(targetBand.amplitudes);
            
            // 在全频谱中滑动窗口寻找相似片段
            const stepSize = 5; // MHz
            const matches = [];
            
            for (let startFreq = 10; startFreq <= 1000 - targetWidth; startFreq += stepSize) {
                // 跳过目标频段自身
                if (Math.abs(startFreq - targetStart) < targetWidth) continue;
                
                const candidateBand = extractBand(sampleSpectrumData, startFreq, targetWidth);
                if (!candidateBand) continue;
                
                const normalizedCandidate = normalizeSpectrum(candidateBand.amplitudes);
                const similarity = cosineSimilarity(normalizedTarget, normalizedCandidate);
                
                if (similarity >= threshold) {
                    matches.push({
                        startFreq,
                        endFreq: startFreq + targetWidth,
                        similarity
                    });
                }
            }
            
            // 显示结果
            displayResults(matches, targetStart, targetWidth);
        });

        // 显示匹配结果
        function displayResults(matches, targetStart, targetWidth) {
            const resultsContainer = document.getElementById('matchesList');
            resultsContainer.innerHTML = '';
            
            if (matches.length === 0) {
                resultsContainer.innerHTML = '<p>未找到相似度达到阈值的频谱片段</p>';
                return;
            }
            
            // 按相似度排序
            matches.sort((a, b) => b.similarity - a.similarity);
            
            // 显示每个匹配项
            matches.forEach(match => {
                const matchElement = document.createElement('div');
                matchElement.className = 'match-item';
                matchElement.innerHTML = `
                    <p><strong>频段:</strong> ${match.startFreq.toFixed(1)}MHz - ${match.endFreq.toFixed(1)}MHz</p>
                    <p><strong>与目标频段(${targetStart}MHz-${targetStart + targetWidth}MHz)的相似度:</strong> ${match.similarity.toFixed(3)}</p>
                `;
                resultsContainer.appendChild(matchElement);
            });
        }
    </script>
</body>
</html>
