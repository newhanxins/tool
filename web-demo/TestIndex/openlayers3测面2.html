<!DOCTYPE html>
<html>
  <head>
    <title>Measure</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/css/ol.css">
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/build/ol.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/ol@6.15.1/dist/ol.js"></script> 

    <!-- https://openlayers.org/en/v5.3.0/css/ol.css
https://openlayers.org/en/v5.3.0/build/ol.js -->
     <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
    <!-- <link rel="stylesheet" href="https://openlayers.org/en/v4.6.5/css/ol.css" type="text/css">
   
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
    <script src="https://openlayers.org/en/v4.6.5/build/ol.js"></script> -->
    <style>
        #map{
            width: 100%;
            height: 800px;
        }
      .tooltip {
        position: relative;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 4px;
        color: white;
        padding: 4px 8px;
        opacity: 0.7;
        white-space: nowrap;
      }
      .tooltip-measure {
        opacity: 1;
        font-weight: bold;
      }
      .tooltip-static {
        background-color: #ffcc33;
        color: black;
        border: 1px solid white;
      }
      .tooltip-measure:before,
      .tooltip-static:before {
        border-top: 6px solid rgba(0, 0, 0, 0.5);
        border-right: 6px solid transparent;
        border-left: 6px solid transparent;
        content: "";
        position: absolute;
        bottom: -6px;
        margin-left: -7px;
        left: 50%;
      }
      .tooltip-static:before {
        border-top-color: #ffcc33;
      }    </style>
  </head>
  <body>
    <div id="map" class="map"></div>
    <form class="form-inline">
      <label>Measurement type &nbsp;</label>
      <select id="type">
        <option value="length">Length (LineString)</option>
        <option value="area">Area (Polygon)</option>

      </select>
    </form>
    <script>
    //   var raster = new ol.layer.Tile({
    //     source: new ol.source.OSM()
    //   });
      var raster=new ol.layer.Tile({
        source: new ol.source.XYZ({
            url: 'http://wprd0{1-4}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&style=7&x={x}&y={y}&z={z}'
        }),
    })
      var source = new ol.source.Vector();

      var vector = new ol.layer.Vector({
        source: source,
        style: new ol.style.Style({
          fill: new ol.style.Fill({
            color: 'rgba(255, 255, 255, 0.2)'
          }),
          stroke: new ol.style.Stroke({
            color: '#ffcc33',
            width: 2
          }),
          image: new ol.style.Circle({
            radius: 7,
            fill: new ol.style.Fill({
              color: '#ffcc33'
            })
          })
        })
      });


      /**
       * 当前正在绘制的要素。
       * Currently drawn feature.
       * @type {ol.Feature}
       */
      var sketch;

      /**
       * 帮助提示元素。
       * The help tooltip element.
       * @type {Element}
       */
      var helpTooltipElement;

      /**
       * 用于显示帮助信息的覆盖层。
       * Overlay to show the help messages.
       * @type {ol.Overlay}
       */
      var helpTooltip;

      /**
       * 测量提示元素。
       * The measure tooltip element.
       * @type {Element}
       */
      var measureTooltipElement;

      /**
       * 用于显示测量结果的覆盖层。
       * Overlay to show the measurement.
       * @type {ol.Overlay}
       */
      var measureTooltip;

      /**
       * 用户绘制多边形时显示的提示信息。
       * Message to show when the user is drawing a polygon.
       * @type {string}
       */
      var continuePolygonMsg = 'Click to continue drawing the polygon';

      /**
       * 用户绘制线时显示的提示信息。
       * Message to show when the user is drawing a line.
       * @type {string}
       */
      var continueLineMsg = 'Click to continue drawing the line';

      /**
       * 鼠标移动事件处理函数。
       * Handle pointer move.
       * @param {ol.MapBrowserEvent} evt 事件对象。
       */
      var pointerMoveHandler = function(evt) {
        if (evt.dragging) {
          return;
        }
        /** @type {string} */
        var helpMsg = 'Click to start drawing'; // 默认提示

        if (sketch) {
          var geom = (sketch.getGeometry());
          if (geom instanceof ol.geom.Polygon) {
            helpMsg = continuePolygonMsg;
          } else if (geom instanceof ol.geom.LineString) {
            helpMsg = continueLineMsg;
          }
        }

        helpTooltipElement.innerHTML = helpMsg;
        helpTooltip.setPosition(evt.coordinate);
        helpTooltipElement.classList.remove('hidden');
      };


      var map = new ol.Map({
        layers: [raster, vector],
        target: 'map',
        view: new ol.View({
            center: new ol.proj.fromLonLat([114.4250, 23.0890]),
            zoom: 18,
            maxZoom: 20
        })
      });

      map.on('pointermove', pointerMoveHandler);

      map.getViewport().addEventListener('mouseout', function() {
        helpTooltipElement.classList.add('hidden');
      });

      var typeSelect = document.getElementById('type');

      var draw; // global so we can remove it later


      /**
       * Format length output.
       * @param {ol.geom.LineString} line The line.
       * @return {string} The formatted length.
       */
      var formatLength = function(line) {
        // 坐标系转换（若原始数据为4326）
        var sourceProj = map.getView().getProjection();
        console.log(sourceProj);
        // 如果原始数据是WGS84坐标系
        var sourceProjs = 'EPSG:4326';
        // line.transform('EPSG:3857', sourceProjs);
        // 计算线的长度并四舍五入到小数点后两位
        // var length = ol.sphere.getLength(line, {
        //   projection: sourceProjs,
        // });
        var length = ol.sphere.getLength(line);
        //  var length = Math.round(line.getLength() * 100) / 100;
                   
        //var length = ol.Sphere.getLength(line, {
        //   projection: "EPSG:4326",
        // });
        var output;
        if (length > 100) {
          output = (Math.round(length / 1000 * 100) / 100) +
              ' ' + 'km';
        } else {
          output = (Math.round(length * 100) / 100) +
              ' ' + 'm';
        }
        return output;
      };


      /**
       * Format area output.
       * @param {ol.geom.Polygon} polygon The polygon.
       * @return {string} Formatted area.
       */
      var formatArea = function(polygon) {
        // var area = ol.sphere.getArea(polygon, {
        //   projection: "EPSG:4326",
        // });
        var area = ol.sphere.getArea(polygon);
        var output;
        if (area > 10000) {
          output = (Math.round(area / 1000000 * 100) / 100) +
              ' ' + 'km<sup>2</sup>';
        } else {
          output = (Math.round(area * 100) / 100) +
              ' ' + 'm<sup>2</sup>';
        }
        return output;
      };
      // ES5实现代码
        var formatAreas = function(polygon) {
        // 1. 创建WGS84球体模型（地球半径6378137米）
        var wgs84Sphere = new ol.Sphere(6378137); 
        // 根据不同标准选择（单位：米）
        // var sphere = new ol.Sphere(6378137);  // WGS84标准
        // var sphere = new ol.Sphere(6362790);  // 国内测绘常用
// 6378137：WGS84标准椭球体长半轴（推荐）‌14
// 6371008.8：IUGG推荐平均半径‌5
// 6362790：国内高程系统专用值
        // 2. 坐标系转换（确保源数据为WGS84）强制转换‌到WGS84（EPSG:4326）
        polygon.transform('EPSG:3857', 'EPSG:4326');
        
        var totalArea = 0;
        
        // 3. 处理多边形外环
        var outerRing = polygon.getLinearRing(0).getCoordinates();
        totalArea += Math.abs(wgs84Sphere.geodesicArea(outerRing));
        
        // 4. 处理内部孔洞（减面积）
        for (var i = 1; i < polygon.getLinearRingCount(); i++) {
            var innerRing = polygon.getLinearRing(i).getCoordinates();
            totalArea -= Math.abs(wgs84Sphere.geodesicArea(innerRing));
        }
        // 自动选择合适单位
        if(totalArea > 10000) {
            return (totalArea/1000000).toFixed(2) + " km²";
        } else {
            return totalArea.toFixed(2) + " m²";
        }
        // 5. 单位换算（示例转亩）
        // return (totalArea * 0.0015).toFixed(2) + ' 亩'; 
        };

      function addInteraction() {
        var type = (typeSelect.value == 'area' ? 'Polygon' : 'LineString');
        draw = new ol.interaction.Draw({
          source: source,
          type: type,
          style: new ol.style.Style({
            fill: new ol.style.Fill({
              color: 'rgba(255, 255, 255, 0.2)'
            }),
            stroke: new ol.style.Stroke({
              color: 'rgba(0, 0, 0, 0.5)',
              lineDash: [10, 10],
              width: 2
            }),
            image: new ol.style.Circle({
              radius: 5,
              stroke: new ol.style.Stroke({
                color: 'rgba(0, 0, 0, 0.7)'
              }),
              fill: new ol.style.Fill({
                color: 'rgba(255, 255, 255, 0.2)'
              })
            })
          })
        });
        map.addInteraction(draw);

        createMeasureTooltip();
        createHelpTooltip();

        var listener;
        draw.on('drawstart',
            function(evt) {
              // set sketch
              sketch = evt.feature;

              /** @type {ol.Coordinate|undefined} */
              var tooltipCoord = evt.coordinate;

              listener = sketch.getGeometry().on('change', function(evt) {
                var geom = evt.target;
                var output;
                if (geom instanceof ol.geom.Polygon) {
                  output = formatArea(geom);
                  tooltipCoord = geom.getInteriorPoint().getCoordinates();
                } else if (geom instanceof ol.geom.LineString) {
                  output = formatLength(geom);
                  tooltipCoord = geom.getLastCoordinate();
                }
                measureTooltipElement.innerHTML = output;
                measureTooltip.setPosition(tooltipCoord);
              });
            }, this);

        draw.on('drawend',
            function() {
              measureTooltipElement.className = 'tooltip tooltip-static';
              measureTooltip.setOffset([0, -7]);
              // unset sketch
              sketch = null;
              // unset tooltip so that a new one can be created
              measureTooltipElement = null;
              createMeasureTooltip();
              ol.Observable.unByKey(listener);
            }, this);
      }


      /**
       * Creates a new help tooltip
       */
      function createHelpTooltip() {
        if (helpTooltipElement) {
          helpTooltipElement.parentNode.removeChild(helpTooltipElement);
        }
        helpTooltipElement = document.createElement('div');
        helpTooltipElement.className = 'tooltip hidden';
        helpTooltip = new ol.Overlay({
          element: helpTooltipElement,
          offset: [15, 0],
          positioning: 'center-left'
        });
        map.addOverlay(helpTooltip);
      }


      /**
       * Creates a new measure tooltip
       */
      function createMeasureTooltip() {
        if (measureTooltipElement) {
          measureTooltipElement.parentNode.removeChild(measureTooltipElement);
        }
        measureTooltipElement = document.createElement('div');
        measureTooltipElement.className = 'tooltip tooltip-measure';
        measureTooltip = new ol.Overlay({
          element: measureTooltipElement,
          offset: [0, -15],
          positioning: 'bottom-center'
        });
        map.addOverlay(measureTooltip);
      }


      /**
       * Let user change the geometry type.
       */
      typeSelect.onchange = function() {
        map.removeInteraction(draw);
        addInteraction();
      };

      addInteraction();
    </script>
  </body>
</html>