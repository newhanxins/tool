<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D卡通粒子系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        }
        .control-panel {
            backdrop-filter: blur(15px);
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.25);
        }
        .particle-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.02);
        }
        .loading-screen {
            backdrop-filter: blur(20px);
            background: rgba(0, 0, 0, 0.8);
        }
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>
<body class="bg-gray-900">
    <!-- 加载界面 -->
    <div id="loadingScreen" class="loading-screen fixed inset-0 z-50 flex items-center justify-center text-white">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
            <h2 class="text-2xl font-bold mb-2 gradient-text">加载中...</h2>
            <p class="text-blue-200">正在初始化3D粒子系统</p>
            <div class="mt-4 w-64 bg-gray-700 rounded-full h-2">
                <div id="progressBar" class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- 控制面板 -->
    <div class="control-panel fixed top-6 left-6 w-80 rounded-2xl p-6 text-white z-10">
        <h1 class="text-2xl font-bold mb-6 flex items-center">
            <i class="fas fa-stars mr-3 text-yellow-300"></i>
            <span class="gradient-text">3D卡通粒子系统</span>
        </h1>

        <!-- 粒子类型选择 -->
        <div class="mb-6">
            <h2 class="text-lg font-semibold mb-3">选择粒子类型</h2>
            <div class="grid grid-cols-2 gap-2">
                <button id="emojiBtn" class="particle-btn active py-3 rounded-xl transition-all bg-gray-700 hover:bg-gray-600">
                <i class="fas fa-smile mr-2"></i>表情符号
                </button>
                <button id="cartoonBtn" class="particle-btn py-3 rounded-xl transition-all bg-gray-700 hover:bg-gray-600">
                <i class="fas fa-gamepad mr-2"></i>卡通角色
                </button>
            </div>
        </div>

        <!-- 形状选择 -->
        <div class="mb-6">
            <h2 class="text-lg font-semibold mb-3">选择形状</h2>
            <div class="grid grid-cols-2 gap-2">
                <button id="earthBtn" class="particle-btn py-3 rounded-xl transition-all bg-gray-700 hover:bg-gray-600">
                <i class="fas fa-globe mr-2"></i>地球
                </button>
                <button id="flowerBtn" class="particle-btn py-3 rounded-xl transition-all bg-gray-700 hover:bg-gray-600">
                <i class="fas fa-flower mr-2"></i>花朵
                </button>
                <button id="saturnBtn" class="particle-btn active py-3 rounded-xl transition-all bg-gray-700 hover:bg-gray-600">
                <i class="fas fa-ring mr-2"></i>土星
                </button>
                <button id="heartBtn" class="particle-btn py-3 rounded-xl transition-all bg-gray-700 hover:bg-gray-600">
                <i class="fas fa-heart mr-2"></i>爱心
                </button>
            </div>
        </div>

        <!-- 颜色主题 -->
        <div class="mb-6">
            <h2 class="text-lg font-semibold mb-3">颜色主题</h2>
            <div class="grid grid-cols-6 gap-2">
                <div class="color-option active w-8 h-8 bg-blue-500 rounded-full cursor-pointer transition-all" data-color="#3B82F6"></div>
                <div class="color-option w-8 h-8 bg-red-500 rounded-full cursor-pointer transition-all" data-color="#EF4444"></div>
                <div class="color-option w-8 h-8 bg-green-500 rounded-full cursor-pointer transition-all" data-color="#10B981"></div>
                <div class="color-option w-8 h-8 bg-yellow-500 rounded-full cursor-pointer transition-all" data-color="#F59E0B"></div>
                <div class="color-option w-8 h-8 bg-purple-500 rounded-full cursor-pointer transition-all" data-color="#8B5CF6"></div>
                <div class="color-option w-8 h-8 bg-pink-500 rounded-full cursor-pointer transition-all" data-color="#EC4899"></div>
            </div>
        </div>

        <!-- 粒子设置 -->
        <div class="mb-6">
            <h2 class="text-lg font-semibold mb-3">粒子设置</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm mb-2">粒子数量: <span id="particleCount">50</span></label>
                    <input type="range" id="particleSlider" min="10" max="200" value="50" class="w-full">
                </div>
                <div>
                    <label class="block text-sm mb-2">粒子大小: <span id="particleSize">1.5</span></label>
                    <input type="range" id="sizeSlider" min="0.5" max="3" step="0.1" value="1.5" class="w-full">
                </div>
                <div>
                    <label class="block text-sm mb-2">旋转速度: <span id="rotationSpeed">1</span></label>
                    <input type="range" id="rotationSlider" min="0" max="3" step="0.1" value="1" class="w-full">
                </div>
            </div>
        </div>

        <!-- 系统状态 -->
        <div class="bg-gray-800 rounded-xl p-4">
            <div class="flex items-center mb-2">
                <i class="fas fa-info-circle mr-2 text-blue-400"></i>
                <span id="systemStatus">系统初始化中</span>
            </div>
            <div class="text-sm text-gray-300">
                粒子总数: <span id="totalParticles">50</span>
            </div>
        </div>
    </div>

    <!-- 信息面板 -->
    <div class="fixed bottom-6 left-6 text-white z-10">
        <div class="flex items-center space-x-4">
            <div class="flex items-center bg-black bg-opacity-50 px-4 py-2 rounded-xl">
                <i class="fas fa-cube mr-2"></i>
                <span id="shapeInfo">土星 - 3D地图效果</span>
            </div>
        </div>
    </div>

    <!-- Three.js 容器 -->
    <div id="threeContainer" class="w-full h-full"></div>

    <script>
        // 3D粒子系统主类
        class ParticleSystem3D {
            constructor() {
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.particleGroup = null;
                this.saturnRing = null;
                this.currentShape = 'saturn';
                this.particleType = 'emoji';
                this.currentColor = '#3B82F6';
                this.particleCount = 50;
                this.particleSize = 1.5;
                this.rotationSpeed = 1;
                this.loadedResources = 0;
                this.totalResources = 8;
                this.init();
            }

            async init() {
                await this.initThreeJS();
                await this.initParticleSystem();
                this.setupEventListeners();
                this.animate();
            }

            async initThreeJS() {
                // 创建场景
                this.scene = new THREE.Scene();
                this.scene.fog = new THREE.Fog(0x1e3c72, 50, 300);
                
                // 创建相机
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                this.camera.position.set(0, 0, 150);
                
                // 创建渲染器
                this.renderer = new THREE.WebGLRenderer({ 
                    antialias: true,
                    alpha: true
                });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                document.getElementById('threeContainer').appendChild(this.renderer.domElement);
                
                // 添加环境光
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                this.scene.add(ambientLight);
                
                // 添加定向光
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(50, 50, 50);
                this.scene.add(directionalLight);
                
                // 窗口大小调整
                window.addEventListener('resize', () => this.onWindowResize());
            }

            async initParticleSystem() {
                this.particleGroup = new THREE.Group();
                this.scene.add(this.particleGroup);
                
                // 创建土星环
                await this.createSaturnRing();
                
                // 创建粒子
                await this.createParticles();
            }

            async createSaturnRing() {
                const ringGeometry = new THREE.RingGeometry(40, 60, 64);
                const ringTexture = await this.loadTexture('https://picsum.photos/1024/1024?grayscale&blur=2');
                
                const ringMaterial = new THREE.MeshBasicMaterial({
                    map: ringTexture,
                    side: THREE.DoubleSide,
                    transparent: true,
                    opacity: 0.7
                });
                
                this.saturnRing = new THREE.Mesh(ringGeometry, ringMaterial);
                this.saturnRing.rotation.x = Math.PI / 2;
                this.scene.add(this.saturnRing);
                this.updateProgress();
            }

            async createParticles() {
                // 清空现有粒子
                while(this.particleGroup.children.length > 0) {
                    this.particleGroup.remove(this.particleGroup.children[0]);
                }
                
                const particleUrls = this.getParticleUrls();
                
                for (let i = 0; i < this.particleCount; i++) {
                    await this.createSingleParticle(i, particleUrls);
                }
            }

            async createSingleParticle(index, urls) {
                const texture = await this.loadTexture(urls[index % urls.length]);
                    
                const spriteMaterial = new THREE.SpriteMaterial({
                    map: texture,
                    transparent: true,
                    opacity: 0.9
                });
                
                const sprite = new THREE.Sprite(spriteMaterial);
                
                // 设置粒子位置
                const position = this.calculateParticlePosition(index);
                sprite.position.copy(position);
                
                // 设置粒子大小
                sprite.scale.set(this.particleSize * 10, this.particleSize * 10, 1);
                
                this.particleGroup.add(sprite);
                this.updateProgress();
            }

            getParticleUrls() {
                if (this.particleType === 'emoji') {
                    return [
                        'https://picsum.photos/200/200?emoji=smile',
                        'https://picsum.photos/200/200?emoji=heart',
                        'https://picsum.photos/200/200?emoji=star',
                        'https://picsum.photos/200/200?emoji=moon',
                        'https://picsum.photos/200/200?emoji=sun'
                    ];
                } else {
                    return [
                        'https://picsum.photos/200/200?cartoon=cat',
                        'https://picsum.photos/200/200?cartoon=dog',
                        'https://picsum.photos/200/200?cartoon=rabbit',
                        'https://picsum.photos/200/200?cartoon=fox',
                        'https://picsum.photos/200/200?cartoon=panda'
                    ];
                }
            }

            calculateParticlePosition(index) {
                const radius = 30 + Math.random() * 10;
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos(2 * Math.random() - 1);
                return new THREE.Vector3(
                    radius * Math.sin(phi) * Math.cos(theta),
                    radius * Math.sin(phi) * Math.sin(theta),
                    radius * Math.cos(phi)
                );
            }

            async loadTexture(url) {
                return new Promise((resolve, reject) => {
                    const loader = new THREE.TextureLoader();
                    loader.load(url, resolve, undefined, reject);
                });
            }

            updateProgress() {
                this.loadedResources++;
                const progress = (this.loadedResources / this.totalResources) * 100;
                document.getElementById('progressBar').style.width = `${progress}%`;
                
                if (this.loadedResources >= this.totalResources) {
                    setTimeout(() => {
                        document.getElementById('loadingScreen').style.display = 'none';
                        document.getElementById('systemStatus').textContent = '系统就绪';
                    }, 500);
                }
            }

            onWindowResize() {
                this.camera.aspect = window.innerWidth / window.innerHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(window.innerWidth, window.innerHeight);
            }

            animate() {
                requestAnimationFrame(() => this.animate());
                
                // 更新粒子系统
                if (this.particleGroup) {
                    this.particleGroup.rotation.y += 0.002 * this.rotationSpeed;
                    this.particleGroup.rotation.x += 0.001 * this.rotationSpeed;
                }
                
                // 更新土星环
                if (this.saturnRing) {
                    this.saturnRing.rotation.z += 0.001 * this.rotationSpeed;
                }
                
                this.renderer.render(this.scene, this.camera);
            }

            setupEventListeners() {
                // 粒子数量滑块
                document.getElementById('particleSlider').addEventListener('input', (e) => {
                    const count = parseInt(e.target.value);
                    this.particleCount = count;
                    document.getElementById('particleCount').textContent = count;
                    document.getElementById('totalParticles').textContent = count;
                    this.createParticles();
                });
                
                // 粒子大小滑块
                document.getElementById('sizeSlider').addEventListener('input', (e) => {
                    const size = parseFloat(e.target.value);
                    this.particleSize = size;
                    document.getElementById('particleSize').textContent = size;
                    this.createParticles();
                });
                
                // 旋转速度滑块
                document.getElementById('rotationSlider').addEventListener('input', (e) => {
                    const speed = parseFloat(e.target.value);
                    this.rotationSpeed = speed;
                    document.getElementById('rotationSpeed').textContent = speed;
                });
            }
        }

        // 初始化系统
        document.addEventListener('DOMContentLoaded', () => {
            const particleSystem = new ParticleSystem3D();
            
            // 设置按钮事件
            document.getElementById('emojiBtn').addEventListener('click', () => {
                particleSystem.particleType = 'emoji';
                updateButtonStates('emojiBtn');
                particleSystem.createParticles();
            });
            
            document.getElementById('cartoonBtn').addEventListener('click', () => {
                particleSystem.particleType = 'cartoon';
                updateButtonStates('cartoonBtn');
                particleSystem.createParticles();
            });
            
            // 形状按钮事件
            const shapeButtons = ['earthBtn', 'flowerBtn', 'saturnBtn', 'heartBtn'];
            shapeButtons.forEach(btnId => {
                document.getElementById(btnId).addEventListener('click', () => {
                    particleSystem.currentShape = btnId.replace('Btn', '');
                    updateButtonStates(btnId);
                    particleSystem.createParticles();
                });
            });
            
            // 颜色选项事件
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', () => {
                    particleSystem.currentColor = option.getAttribute('data-color');
                    updateColorStates(option.getAttribute('data-color'));
                });
            });
            
            function updateButtonStates(activeId) {
                document.querySelectorAll('.particle-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById(activeId).classList.add('active');
            }
            
            function updateColorStates(activeColor) {
                document.querySelectorAll('.color-option').forEach(option => {
                    option.classList.remove('active');
                });
                document.querySelector(`[data-color="${activeColor}"]`).classList.add('active');
            }
        });
    </script>
</body>
</html>
