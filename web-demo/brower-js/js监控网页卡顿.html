<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        html,body{
            margin:0;
            padding:0;
            height: 100%;
            width: 100%;
        }
        #conterbox{
            display: flex;
            width: 100%;
            height:100%;
            padding:10px;
            box-sizing: border-box;
        }
        ul{
            padding:0;
        }
        ul li{
            list-style-type: none;
        }
        #leftbox{
            width: 30%;
            border:1px solid #ddd;
        }
        #rightbox{
            width: 70%;
        }
        .headertitle{
            height: 60px;
            line-height: 60px;
            width: 100%;
            font-size: 18px;
            text-align: center;
            font-weight: bold;
            border-bottom: 1px solid #ddd;
        }
        .title{
            height: 30px;
            line-height: 30px;
            width: 100%;
            font-size: 16px;
            text-indent: 2px;
            font-weight: bold;
        }
        .inforul li{
            height: 30px;
            line-height: 30px;
            padding-left: 20px;
        }
        .inforul li input{
            width: 200px;
            height: 26px;
            outline: none;
        }
    </style>
</head>
<body>
    <div id="conterbox">
        <div id="leftbox">
            <div class="headertitle">系统关联相关信息</div>
            <p class="title">基本信息</p>
            <ul class="inforul">
                <li>
                    <label for="">区（市）县</label>
                    <input type="text">
                </li>
            </ul>
        </div>
        <div id="rightbox">

        </div>
        <button id="but">测试点击内存泄漏</button>
    </div>
    <script type="text/javascript">

var arr1 = [];
let buts=document.getElementById("but")
getPerformance()
buts.addEventListener("click", function() {
	var a = new Array(100000).fill(1);
	var b = new Array(20000).fill(1);
  
    arr1.push(b);
    arr1=[]
  getPerformance()
});






        // 网页卡顿
        //FPS https://www.cnblogs.com/coco1s/p/8029582.html
        var rAF = function () {
    return (
        window.requestAnimationFrame ||
        window.webkitRequestAnimationFrame ||
        function (callback) {
            window.setTimeout(callback, 1000 / 60);
        }
    );
}();
  
var frame = 0;
var allFrameCount = 0;
var lastTime = Date.now();
var lastFameTime = Date.now();
  
var loop = function () {
    var now = Date.now();
    var fs = (now - lastFameTime);
    var fps = Math.round(1000 / fs);
  
    lastFameTime = now;
    // 不置 0，在动画的开头及结尾记录此值的差值算出 FPS
    allFrameCount++;
    frame++;
  
    if (now > 1000 + lastTime) {
        var fps = Math.round((frame * 1000) / (now - lastTime));
        console.log(`${new Date()} 1S内 FPS：`, fps);
        frame = 0;
        lastTime = now;
    };
    rAF(loop);
}
// loop();//FPS 帧数




//Performance
var rendererEvents = window.performance.getEntriesByType("renderer");
var compositeThreadEvents = window.performance.getEntriesByType("composite");
var observer = new PerformanceObserver(function(list) {
    var perfEntries = list.getEntries();
    for (var i = 0; i < perfEntries.length; i++) {
        console.log("frame: ", perfEntries[i]);
    }
    for(const entry of list.getEntries()){
   console.groupCollapsed(entry.name);
   console.log(entry.entryType);
   console.log(entry.startTime);
   console.log(entry.duration);
   console.groupEnd(entry.name);
  }


});
 
// subscribe to Frame Timing
observer.observe({entryTypes:['longtask','frame','navigation','resource','mark','measure','paint']});
// observer.observe({entryTypes: ['frame']});
// 使用 PerformanceObserver 监听 fcp
//https://blog.csdn.net/weixin_43964148/article/details/124089667
if (!!PerformanceObserver){
    try {
      const type = 'paint';
      if ((PerformanceObserver.supportedEntryTypes || []).includes(type)) {
        observer = new PerformanceObserver((entryList)=>{
          for(const entry of entryList.getEntriesByName('first-contentful-paint')){
            const { startTime,duration } = entry;
            console.log('[assets-load-monitor] PerformanceObserver fcp:', startTime+duration);
            
            // 上报startTime操作
          }
        });
        observer.observe({
          entryTypes: [type],
        });
      }
    } catch (e) {
      // ios 不支持这种entryTypes，会报错 https://caniuse.com/?search=PerformancePaintTiming
      console.warn('[assets-load-monitor] PerformanceObserver error:', (e || {}).message ? e.message : e);
    }
  }


// 获取页面资源加载的时间性能信息

window.onload = function(){
    setTimeout(function(){
        let t = performance.timing
        console.log('DNS查询耗时 ：' + (t.domainLookupEnd - t.domainLookupStart).toFixed(0))
        console.log('TCP链接耗时 ：' + (t.connectEnd - t.connectStart).toFixed(0))
        console.log('request请求耗时 ：' + (t.responseEnd - t.responseStart).toFixed(0))
        console.log('解析dom树耗时 ：' + (t.domComplete - t.domInteractive).toFixed(0))
        console.log('白屏时间 ：' + (t.responseStart - t.navigationStart).toFixed(0))
        console.log('domready时间 ：' + (t.domContentLoadedEventEnd - t.navigationStart).toFixed(0))
        console.log('onload时间 ：' + (t.loadEventEnd - t.navigationStart).toFixed(0))

        if(t = performance.memory){
            console.log('js内存使用占比 ：' + (t.usedJSHeapSize / t.totalJSHeapSize * 100).toFixed(2) + '%')
        }
    })
}
//获取performance信息
getPerformance()
function getPerformance() {
  if (!window.performance) return
//   setInterval(function(){
    const timing = window.performance.timing
    const memorys=window.performance.memory
    console.log(memorys)
    let info={
        whiteScreen: timing.domLoading - timing.navigationStart, // 白屏时间
        redirect: timing.redirectEnd - timing.redirectStart, // 重定向耗时
        dom: timing.domComplete - timing.domLoading, // dom渲染耗时
        load: timing.loadEventEnd - timing.navigationStart, // 页面加载耗时
        unload: timing.unloadEventEnd - timing.unloadEventStart, // 页面卸载耗时
        request: timing.responseEnd - timing.requestStart, // 请求耗时
        HeapSize:memorys.usedJSHeapSize-memorys.totalJSHeapSize,//内存剩余量
        time: new Date().getTime(), // 获取性能信息时当前时间
    }
    // console.log(info)
//   },2000)
}
//获取资源信息
function getResources() {
  if (!window.performance) return
  const data = window.performance.getEntriesByType('resource')
  const resources = {
    css: [],
    img: [],
    script: [],
    xmlhttprequest: [],
    link: [],
    fetch: [],
    iframe: [],
    other: [],
    time: new Date().getTime()  // 获取资源信息时当前时间
  }
  data.forEach(item => {
    let key = resources[item.initiatorType]?item.initiatorType:'other'
    resources[key].push({
      name: item.name, // 资源的名称
      duration: item.duration.toFixed(2), // 资源加载耗时
      size: item.transferSize, // 资源大小
      protocol: item.nextHopProtocol, // 资源所用协议
    })
  })
  return resources
}






//网页崩溃监测 方法有弊端
window.addEventListener('load', function () {
      sessionStorage.setItem('good_exit', 'pending');
      setInterval(function () {
         sessionStorage.setItem('time_before_crash', new Date().toString());
      }, 1000);
   });

   window.addEventListener('beforeunload', function () {
      sessionStorage.setItem('good_exit', 'true');
   });

   if(sessionStorage.getItem('good_exit') &&
      sessionStorage.getItem('good_exit') !== 'true') {
      /*
         insert crash logging code here
     */
      alert('Hey, welcome back from your crash, looks like you crashed on: ' + sessionStorage.getItem('time_before_crash'));
   }
    </script>
</body>
</html>