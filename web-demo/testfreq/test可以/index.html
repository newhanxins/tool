<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv=Content-Type content="text/html;charset=utf-8">
<meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0,maximum-scale=1.0, user-scalable=no"/>

  <title>Interactive Map with Canvas</title>
  <script type="text/javascript" src="js/jquery-1.11.2.min.js"></script>
  <style>
    body{
      background:#ddd;
    }
    canvas {
      border: 1px solid red;
      display: block;
      margin: 0 auto;
    }
    button{
      width: 100px;
      height: 40px;
    }
  </style>
</head>
<body>
  <button id="startdraw">绘制</button>
  <button onclick="window.location.reload()">刷新</button>
<canvas id="myCanvas" width="600" height="400"></canvas>

<div id="consolelogs"></div>
<script src="dist/index.js"></script>
<!-- <script>
// 获取 canvas 元素和上下文
var canvas=""
var ctx=""
window.onload=function(){
  canvas = document.getElementById('myCanvas');
  ctx = canvas.getContext('2d');
  ctx.fillStyle = 'rgba(0, 150, 255, 0.5)';
  ctx.fillRect(20, 10, 200, 110);
if(ctx){
  alert(11)
}else{
  alert(333)
}
// 示例数据：省份和市区的坐标 (假设为矩形区域，实际应用可根据数据调整)
var areas = [
  { id: 1, name: 'City 1', x: 50, y: 50, width: 150, height: 100 },
  { id: 2, name: 'City 1111111111111111111111111111112', x: 200, y: 50, width: 150, height: 30 },
  { id: 3, name: 'City 3', x: 50, y: 150, width: 150, height: 100 },
  { id: 4, name: 'City 4', x: 200, y: 150, width: 150, height: 100 },
  { id: 5, name: '水上移动', x: 200, y: 350, width: 150, height: 100 },
];

var selectedArea = null;
var offsetX = 0, offsetY = 0;
var scaleX = 1, scaleY = 1; // X轴和Y轴分别独立缩放
var scaleDirection = 'both'; // 缩放方向，'x'：只缩放X轴，'y'：只缩放Y轴，'both'：同时缩放X轴和Y轴

function alert1111(st){
  alert(st)
}
// 绘制地图
var startdrawdom=document.getElementById("startdraw")
startdrawdom.onclick=function(){
  drawMap()
}
function drawMap() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);  // 清空画布
  
  // 绘制所有区域
  areas.forEach(function(area){
    // 根据缩放比例调整区域位置和尺寸
    var x = area.x * scaleX + offsetX;
    var y = area.y * scaleY + offsetY;
    var width = area.width * scaleX;
    var height = area.height * scaleY;

    // 绘制区域矩形
    ctx.fillStyle = 'rgba(0, 150, 255, 0.5)';
    ctx.fillRect(x, y, width, height);

    // 绘制区域边框
    ctx.strokeStyle = 'blue';
    ctx.lineWidth = 2;
    ctx.strokeRect(x, y, width, height);

    // 绘制文字
    drawText(area, x, y, width, height);
  });

  // 高亮选中的区域
  if (selectedArea) {
    ctx.strokeStyle = 'red';
    ctx.lineWidth = 3;
    var x = selectedArea.x * scaleX + offsetX;
    var y = selectedArea.y * scaleY + offsetY;
    var width = selectedArea.width * scaleX;
    var height = selectedArea.height * scaleY;
    ctx.strokeRect(x, y, width, height);
  }
}

// 绘制区域中的文字
function drawText(area, x, y, width, height) {
  var fontSize = 16;
  ctx.font = fontSize+"px Arial";
  ctx.fillStyle = 'black';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';

  var text = area.name;
  var textWidth = ctx.measureText(text).width;

  // 文字显示方式
  if (width >= textWidth) {
    // 如果宽度足够，一行显示文字并居中
    ctx.fillText(text, x + width / 2, y + height / 2);
  } else if (width >= fontSize * 2) {
    // 如果宽度不足以显示一行文字但足够显示两行
    var lineHeight = fontSize * 1.2;
    var maxLines = Math.floor(height / lineHeight);
    var lines = splitText(text, width,maxLines);
    
    var totalHeight = lines.length * lineHeight;
    var startY = y + height / 2 - totalHeight / 2+lineHeight/2;

    lines.forEach(function(line, index){
      ctx.fillText(line, x + width / 2, startY + index * lineHeight);
    });
  } else {
    // 如果宽度不足以显示两行文字，文字竖直显示
    var maxHeight = height - 10; // 留点边距
    var maxLines = Math.floor(maxHeight / fontSize);
    if(maxLines==0){
      return;
    }
    var lines = splitText(text, fontSize, maxLines);

    var startY = y + height / 2 - lines.length * fontSize / 2;
    lines.forEach(function(line, index){
      ctx.fillText(line, x + width / 2, startY + index * fontSize);
    });
  }
}

// 处理文本的拆分
function splitText(text, maxWidth, maxLines = Infinity) {
  var lines = [];
  var currentLine = '';

  for (var i = 0; i < text.length; i++) {
    var testLine = currentLine + text[i];
    var testWidth = ctx.measureText(testLine).width;

    if (testWidth > maxWidth) {
      if (currentLine.length > 0) {
        lines.push(currentLine);
      }
      currentLine = text[i]; // Start new line with the current character
    } else {
      currentLine = testLine;
    }

    if (lines.length >= maxLines) {
      break;
    }
  }

  if (currentLine.length > 0) {
    lines.push(currentLine);
  }
  if(maxLines==0){
    lines.splice(0);
  }
  // 如果行数超过最大行数，截断并添加省略号
  if (lines.length > maxLines) {
    lines[maxLines - 1] = lines[maxLines - 1].slice(0, -1) + '...';
    // 删除多余的行
    lines.splice(maxLines);
  }

  return lines;
}

// 检查点击是否在区域内
function checkClick(x, y) {
  var isok=false
  for (var index = 0; index < areas.length; index++) {
    var area=areas[index]
    var areaX = area.x * scaleX + offsetX;
    var areaY = area.y * scaleY + offsetY;
    var areaWidth = area.width * scaleX;
    var areaHeight = area.height * scaleY;
    if(x >= areaX && x <= areaX + areaWidth && y >= areaY && y <= areaY + areaHeight){
      return area
    };
    
  }

// return areas.find(function(area){
//     var areaX = area.x * scaleX + offsetX;
//     var areaY = area.y * scaleY + offsetY;
//     var areaWidth = area.width * scaleX;
//     var areaHeight = area.height * scaleY;
//     return x >= areaX && x <= areaX + areaWidth && y >= areaY && y <= areaY + areaHeight;
//   });
}

// 处理鼠标点击事件
canvas.addEventListener('click', function(e) {
  var mouseX = e.offsetX;
  var mouseY = e.offsetY;
  var clickedArea = checkClick(mouseX, mouseY);
  if (clickedArea) {
    selectedArea = clickedArea;
    drawMap(); // 重新绘制地图并高亮选中区域
  } else {
    selectedArea = null;
    drawMap(); // 重新绘制地图并去掉高亮
  }
});

// 处理鼠标滚轮缩放
canvas.addEventListener('wheel', function(e){
  e.preventDefault();  // 阻止默认滚动行为
  var zoomFactor = e.deltaY < 0 ? 1.1 : 0.9;  // 放大或缩小
console.log(zoomFactor,scaleDirection)
  if (scaleDirection === 'x' || scaleDirection === 'both') {
    scaleX *= zoomFactor;  // 调整X轴的缩放比例
  }
  if (scaleDirection === 'y' || scaleDirection === 'both') {
    scaleY *= zoomFactor;  // 调整Y轴的缩放比例
  }

  // 防止缩放过小或过大
  if (scaleX < 0.5) scaleX = 0.5;
  if (scaleX > 3) scaleX = 3;
  if (scaleY < 0.5) scaleY = 0.5;
  if (scaleY > 3) scaleY = 3;

  drawMap();  // 重新绘制地图
});

// 处理拖动功能
var isDragging = false;
var startX = 0;
var startY = 0;

canvas.addEventListener('mousedown', function(e) {
  isDragging = true;
  startX = e.offsetX - offsetX;
  startY = e.offsetY - offsetY;
});

canvas.addEventListener('mousemove', function(e) {
  if (isDragging) {
    offsetX = e.offsetX - startX;
    offsetY = e.offsetY - startY;
    drawMap();  // 重新绘制地图
  }
});

canvas.addEventListener('mouseup', function(){
  isDragging = false;
});

canvas.addEventListener('mouseleave', function(){
  isDragging = false;
});

// 手指触摸操作
var touchStartDist = 0;
var prevTouchDistance = 0;
var isTouching = false;

canvas.addEventListener('touchstart', function(e) {
  if (e.touches.length == 2) {
    isTouching = true;
    var touch1 = e.touches[0];
    var touch2 = e.touches[1];
    touchStartDist = Math.hypot(touch2.pageX - touch1.pageX, touch2.pageY - touch1.pageY);
    prevTouchDistance = touchStartDist;
  }
});

canvas.addEventListener('touchmove', function(e){
  if (isTouching && e.touches.length == 2) {
    var touch1 = e.touches[0];
    var touch2 = e.touches[1];
    var touchDist = Math.hypot(touch2.pageX - touch1.pageX, touch2.pageY - touch1.pageY);

    // 计算触摸移动的缩放因子
    var scaleChange = touchDist / prevTouchDistance;
    if (scaleDirection === 'x' || scaleDirection === 'both') {
      scaleX *= scaleChange;
    }
    if (scaleDirection === 'y' || scaleDirection === 'both') {
      scaleY *= scaleChange;
    }

    // 防止缩放过小或过大
    if (scaleX < 0.5) scaleX = 0.5;
    if (scaleX > 3) scaleX = 3;
    if (scaleY < 0.5) scaleY = 0.5;
    if (scaleY > 3) scaleY = 3;

    // 更新触摸的上一距离
    prevTouchDistance = touchDist;
    drawMap();  // 重新绘制地图
  }
});

canvas.addEventListener('touchend', function(){
  if (e.touches.length < 2) {
    isTouching = false;
    prevTouchDistance = 0;
  }
});
// 通过键盘切换缩放方向
window.addEventListener('keydown', function(e){
  if (e.key === 'x') {
    scaleDirection = 'x'; // 只缩放X轴
  } else if (e.key === 'y') {
    scaleDirection = 'y'; // 只缩放Y轴
  } else if (e.key === 'b') {
    scaleDirection = 'both'; // 同时缩放X轴和Y轴
  }
});
function showconsole(data){
    var nowdragtimes=new Date().getTime()
    var reqdata=JSON.stringify(data)
    var texts='<p><span>'+nowdragtimes+'</span>'+reqdata+'</p>'
    $("#consolelogs").append(texts)
}

window.addEventListener('error',function(errorMessage, scriptURI, lineNo, columnNo, error){
    var texts="message:"+errorMessage.message+",line:"+errorMessage.lineno+",filename:"+errorMessage.filename+",error"+JSON.stringify(errorMessage)
    var reqdata = '{"request_type":"map_log报错","name":"代码报错报错报错","request_data":'+texts+'}';
    showconsole(reqdata)
}, true);
}
</script> -->

</body>
</html>
